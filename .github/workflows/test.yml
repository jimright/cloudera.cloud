---

name: Preliminary tests

on:
  pull_request:
  workflow_dispatch:
    
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - run: |
          sudo apt-get -y update
          sudo apt-get -y install python3 python3-pip
          sudo update-alternatives --install /usr/bin/python python $(which python3) 1
          pip install ansible-core==2.12 ansible-builder pycodestyle voluptuous pylint
          ansible-galaxy collection install -r builder/requirements.yml -p /usr/share/ansible/collections

      - run: ansible --version
      - run: ansible-galaxy collection list
      - run: |
          ansible-builder introspect \
            --write-pip final_python.txt --write-bindep final_bindep.txt \
            /usr/share/ansible/collections
          pip install -r final_python.txt
          sudo apt-get -y install $(cat final_bindep.txt)
      - run: pip freeze
      - run: |
          pushd /usr/share/ansible/collections/ansible_collections/cloudera/cloud
          #ansible-test sanity --test pep8
          #ansible-test sanity --test validate-modules
          ansible-test units -v --color yes --redact --venv
          popd
